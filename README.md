# OpenExpoOTA Client

React Native client library for OpenExpoOTA - A self-hosted OTA update system for Expo apps.

## Installation

```bash
npm install openexpoota-client expo-updates
```

## Setup

The OpenExpoOTA client works alongside the official `expo-updates` package to provide OTA updates from your self-hosted server.

### Authentication

The client library uses an app key for authentication, rather than user JWT tokens. This approach is simpler and more secure for mobile apps, as it doesn't require storing user credentials.

**How to get your app key:**

1. Create your app in the OpenExpoOTA backend (through the CLI)
2. The CLI will provide you with an app key
3. Use this key in your client configuration

```bash
# From your Expo project directory, run the CLI init command
npx openexpoota-cli init
```

### Environment Variables (Optional)

You can configure the client using environment variables by creating a `.env` file:

```bash
# Copy the example environment file
cp .env.example .env
# Edit with your settings
```

Available environment variables:
- `OTA_API_URL`: URL of your OpenExpoOTA backend API
- `OTA_APP_SLUG`: Identifier for your app (slug name)
- `OTA_APP_KEY`: The app key provided by the CLI
- `OTA_CHECK_INTERVAL`: How often to check for updates (milliseconds)
- `OTA_CHANNEL`: Default release channel (production, staging, development)
- `OTA_UPDATE_MODE`: Update behavior ('auto' or 'manual')

## Features

- Seamless integration with Expo Updates
- Easy-to-use React hooks and providers
- Support for multiple update channels
- Customizable update behavior
- Automatic or manual updates

## Basic Usage

```jsx
import React from 'react';
import { UpdatesProvider, useSelfHostedUpdates } from 'openexpoota-client';
import { ReleaseChannel } from 'openexpoota-client';

export default function App() {
  return (
    <UpdatesProvider
      config={{
        apiUrl: 'http://your-backend-url.com/api',
        appSlug: 'your-app-slug',
        appKey: 'your-app-key', // Generated by CLI when you initialize your app
        channel: ReleaseChannel.PRODUCTION,
        checkInterval: 60000, // Check every minute (in ms)
        updateMode: 'auto' // 'auto' or 'manual'
      }}
    >
      <YourApp />
    </UpdatesProvider>
  );
}

// In a component where you want to control updates
function UpdateControls() {
  const {
    isChecking,
    isUpdateAvailable,
    checkForUpdates,
    downloadUpdate,
    applyUpdate,
    checkOnResume,
    lastUpdateCheck,
    error
  } = useSelfHostedUpdates();

  if (isChecking) {
    return <Text>Checking for updates...</Text>;
  }

  if (isUpdateAvailable) {
    return (
      <Button
        title="Download and Apply Update"
        onPress={async () => {
          await downloadUpdate();
          applyUpdate();
        }}
      />
    );
  }

  return (
    <Button
      title="Check for Updates"
      onPress={checkForUpdates}
    />
  );
}
```

## Advanced Usage

### Custom Update UI

You can fully customize the update experience by using the hooks and building your own UI:

```jsx
import React from 'react';
import { View, Text, Button, StyleSheet } from 'react-native';
import { UpdatesProvider, useSelfHostedUpdates } from 'openexpoota-client';

function CustomUpdateUI() {
  const {
    isChecking,
    isUpdateAvailable,
    updateInfo,
    downloadUpdate,
    applyUpdate,
    checkForUpdates,
    progress,
  } = useSelfHostedUpdates();

  if (isChecking) {
    return (
      <View style={styles.container}>
        <Text style={styles.text}>Checking for updates...</Text>
      </View>
    );
  }

  if (isUpdateAvailable && updateInfo) {
    return (
      <View style={styles.container}>
        <Text style={styles.title}>Update Available!</Text>
        <Text style={styles.text}>Version: {updateInfo.version}</Text>
        <Text style={styles.text}>Channel: {updateInfo.channel}</Text>

        {progress ? (
          <View>
            <Text style={styles.text}>Downloading: {Math.round(progress * 100)}%</Text>
            <View style={styles.progressBar}>
              <View style={[styles.progress, { width: `${progress * 100}%` }]} />
            </View>
          </View>
        ) : (
          <Button
            title="Download and Apply Update"
            onPress={async () => {
              await downloadUpdate();
              applyUpdate();
            }}
          />
        )}
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <Text style={styles.text}>Your app is up to date!</Text>
      <Button title="Check for Updates" onPress={checkForUpdates} />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    padding: 20,
    borderRadius: 10,
    backgroundColor: '#f0f0f0',
    margin: 20,
  },
  title: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 10,
  },
  text: {
    fontSize: 16,
    marginBottom: 5,
  },
  progressBar: {
    height: 10,
    backgroundColor: '#ddd',
    borderRadius: 5,
    marginTop: 10,
  },
  progress: {
    height: '100%',
    backgroundColor: 'green',
    borderRadius: 5,
  },
});
```

## API Reference

### UpdatesProvider Props

| Prop | Type | Description |
|------|------|-------------|
| config | Object | Configuration for the updates system |
| config.apiUrl | string | URL of your OpenExpoOTA backend API |
| config.appSlug | string | Identifier for your app |
| config.appKey | string | App key for authentication (from CLI) |
| config.channel | ReleaseChannel | Release channel to use |
| config.checkInterval | number | How often to check for updates (milliseconds) |
| config.updateMode | 'auto' \| 'manual' | Whether to auto-update or require user interaction |

### useSelfHostedUpdates Hook

| Property | Type | Description |
|----------|------|-------------|
| isChecking | boolean | Whether the system is currently checking for updates |
| isUpdateAvailable | boolean | Whether an update is available |
| updateInfo | Object | Information about the available update |
| error | Error | Error that occurred during checking or downloading |
| progress | number | Download progress (0-1) |
| checkForUpdates | () => Promise<void> | Function to manually check for updates |
| downloadUpdate | () => Promise<void> | Function to download the available update |
| applyUpdate | () => void | Function to apply the downloaded update |
| checkOnResume | boolean | Whether to check for updates when app resumes |
| setCheckOnResume | (check: boolean) => void | Function to set checkOnResume |
| lastUpdateCheck | Date | When the last update check occurred |

## Security Considerations

The app key is used for authentication and should be treated as a secret. However, it has limited permissions - it can only:
- Check for updates for the specific app
- Download update bundles for the specific app

It can't modify backend data or access other apps. For additional security:
- Only use HTTPS for your backend API
- Consider rotating app keys periodically (via the CLI)

## Compatibility

The client library is compatible with the OpenExpoOTA backend using either PostgreSQL directly or Supabase as the database provider.

## License

MIT